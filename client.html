<!DOCTYPE html>
<html>

<head>
    <link href="chat_room.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quicksand">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        var socketio = io.connect();
    </script>
    <style>
         :root {
            /* Panels */
            --left-panel-bg: #0e1525;
            --right-panel-hd: #0d101e;
            --right-panel-bg: #1d2333;
            /* Others */
            --chat-box-bg: #2e3444;
            /* Text */
            --font-color: white;
            --other-users-color: rgb(125, 158, 228);
            --this-user-color: lightgreen;
            --send-btn-color: lightblue;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Quicksand';
            text-align: center;
            color: var(--font-color);
            font-size: 20pt;
            /* filter: blur(0px); */
        }
        
        .room-users {
            box-sizing: border-box;
            height: 100%;
            width: 25%;
            background-color: var(--left-panel-bg);
            display: block;
            margin: 0px;
            position: fixed;
            top: 0px;
            right: -500px;
        }
        
        #create_popup {
            box-sizing: border-box;
            height: 100%;
            width: 25%;
            background-color: var(--left-panel-bg);
            display: block;
            margin: 0px;
            position: fixed;
            top: 0px;
            left: -500px;
        }
        
        .left-panel {
            box-sizing: border-box;
            height: 100%;
            width: 25%;
            background-color: var(--left-panel-bg);
            display: block;
            margin: 0px;
            position: fixed;
            top: 0px;
            left: 0px;
        }
        
        .left-panel .panel-header,
        .room-users .panel-header {
            background-color: var(--left-panel-bg);
        }
        
        .right-panel {
            box-sizing: border-box;
            height: 100%;
            width: 75%;
            background-color: var(--right-panel-bg);
            display: block;
            margin: 0px;
            position: fixed;
            top: 0px;
            right: 0px;
        }
        
        .panel-header {
            box-sizing: border-box;
            font-weight: bold;
            height: 75px;
            width: 100%;
            background-color: var(--right-panel-hd);
            top: 0px;
            position: absolute;
        }
        
        .panel-header p {
            margin-top: 21px;
        }
        
        .login {
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0px;
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: var(--right-panel-bg);
            z-index: 1;
        }
        
        .login_cont {
            margin: 60px;
        }
        
        .chat {
            box-sizing: border-box;
            overflow-y: auto;
            top: 75px;
            width: 100%;
            /* height: 100%; */
            left: 0px;
            right: 0px;
            bottom: 60px;
            position: absolute;
            text-align: left;
            padding: 20px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
         ::-webkit-scrollbar {
            display: none;
        }
        
        .chat p {
            font-size: 15pt;
            margin: 10px;
        }
        
        .chat strong {
            color: var(--other-users-color);
        }
        
        .chat .me {
            color: var(--this-user-color);
        }
        
        .me {
            color: var(--this-user-color);
        }
        
        .chat em {
            color: grey;
        }
        
        .chat-box {
            box-sizing: border-box;
            width: 100%;
            height: 60px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            position: absolute;
            /* background-color: orange; */
            /* padding: 2 */
        }
        
        input[type="text"] {
            box-sizing: border-box;
            margin: 0px;
            width: 100%;
            border-style: none;
            font-family: 'Quicksand';
            background-color: var(--chat-box-bg);
            font-size: 15pt;
            height: 100%;
            position: relative;
            bottom: 0px;
            color: white;
            padding-left: 20px;
        }
        
        input[type="text"]:focus {
            outline: none;
            /* height: 2px; */
        }
        
        #user {
            width: 200px;
            height: 35px;
            padding-left: 5px;
        }
        
        .btn {
            box-sizing: border-box;
            color: var(--other-users-color);
            filter: brightness(1);
        }
        
        .btn:hover {
            filter: brightness(0.8);
            cursor: pointer;
        }
        
        .btn:focus {
            filter: brightness(0.6);
        }
        
        #send_btn {
            width: 30px;
            height: 30px;
            z-index: 1;
            bottom: -10px;
            right: 10px;
            position: absolute;
        }
        
        #create_room {
            width: 30px;
            height: 30px;
            z-index: 1;
            top: 95px;
            right: 10px;
            position: absolute;
        }
        
        #login_btn {
            box-sizing: border-box;
            width: 30px;
            height: 30px;
            z-index: 1;
            position: absolute;
            margin-left: 50%;
            margin-top: -36px;
        }
        /* .room_list {
            text-align: left;
        } */
        
        #user_list {
            margin-top: 80px;
        }
        
        .room_name,
        .user_name {
            font-weight: normal;
            list-style-type: none;
            text-align: left;
            font-size: 15pt;
            margin: 10px;
        }
        
        .pass {
            color: rgb(255, 151, 151);
        }
        /* .room_users {} */
        
        #user_menu {
            color: white;
            position: absolute;
            display: block;
            right: 20px;
            margin-top: 9px;
        }
        
        #close_users {
            box-sizing: border-box;
            color: white;
            position: absolute;
            display: block;
            top: -2px;
            left: 25px;
        }
        
        #close_creation {
            box-sizing: border-box;
            color: white;
            position: absolute;
            display: block;
            top: -2px;
            right: 20px;
        }
        
        #add_room {
            color: white;
            position: absolute;
            left: 20px;
            top: -2px;
        }
        
        #new_room_name {
            height: 70px;
            margin-top: 100px;
        }
        
        #room_pass {
            height: 70px;
            margin-top: 50px;
        }
    </style>

</head>

<body>
    <!-- <div id="login_stuff">
        <p id="login_title">Login</p>

        <div class="enter_username">
            <input type='text' id='user' placeholder='Username' required />
            <button id='join_button' name='user_type' value='user'> Join Chat </button>
        </div>
    </div>

    <div id='chat_header'>
        <h1 id='chat_title_display'>
            Main Lobby
        </h1>
    </div>

    <div id="chatlog"></div>
    <div id="messaging_stuff">
        <input type="text" id="message_input" />
        <button id='send_message'>send</button> <br>
        <div id="chatlog"></div>
    </div>

    <div id="chatlog_room"></div>
    <div id="messaging_to_room">
        <input type="text" id="message_to_room_input" placeholder='send message to room' />
        <button id='send_message_to_room'>send to room</button> <br>
        <div id="chatlog_room"></div>
    </div>


    <div id='rooms_stuff'>
        <p class = 'btn' id='create_room'>Create new room</p>
        <input type="text" id="new_room_name" placeholder='room name' /> <br>

        <label>Room List</label>
        <ul id='room_list'>
            Populate using jQuery -->
    <!-- <li class='room_name'>Main Lobby</li>
        </ul>
    </div> -->
    <div class="login">
        <div class="login_cont">
            <p>Enter Username:</p>
            <input type='text' id='user' placeholder='Username' />
            <!-- <button id='join_button' name='user_type' value='user'> Join Chat </button> -->
            <p class="btn" id="login_btn"> &#x279C; </p>
        </div>

    </div>

    <div class="left-panel">
        <div class="panel-header">
            <!-- HTML for creating room -->
            <p class='btn' id='add_room'> &plus; </p>

            <div id='create_popup'>
                <div class="panel-header">
                    <p>Create Room</p>
                    <p class="btn" id="close_creation">
                        &lt; </p>
                </div>

                <input type="text" id="new_room_name" placeholder='Room name' />
                <input type="text" id="room_pass" placeholder='Password (optional)' />
                <p class='btn' id='create_room'>&#x279C;</p>
            </div>

            <p>Rooms</p>
            <ul id='room_list'>
                <li class='room_name'>Main Room</li>
            </ul>
        </div>
    </div>
    <div class="right-panel">
        <div class="panel-header">
            <p id="curr_room">Main Room</p>
        </div>

        <div class="chat">
            <div class="msgs">

            </div>
            <p id="typing"></p>
        </div>

        <div class="chat-box">
            <input id="chat_text" type="text" placeholder="Tell me your secrets..." />

        </div>
        <p class="btn" id="send_btn"> &#x279C; </p>

        <!-- <img id="send_btn" src="send_icon.png" alt="send" /> -->
    </div>

    <p id="user_menu" class="btn"> &#9776; </p>

    <div class="room-users">
        <div class="panel-header">
            <p>Users</p>
            <p class="btn" id="close_users"> > </p>
        </div>
        <ul id='user_list'>
            <!-- <li class='user_name'>Sasha</li> -->
        </ul>
    </div>

    <script>
        let username = "";

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        socketio.on("new_user", function(users) {
            user_array = users['users'];
            for (user in user_array) {
                // $('#user_list').append("<li class='user_name' >" + user +  "</li>");
            }

        });


        // $("document").on('click', '.room_name', function() {
        // console.log("clicked on room name");
        // let room_name = $(this).text();
        // let old_room = $('#curr_room').text();
        // $('#curr_room').text(room_name);

        // $(".chat").empty();
        // switchRoom(old_room, room_name);
        // })



        function switchRoom(old_room, room_name) {
            $('#curr_room').text(room_name);

            $(".chat").empty();

            console.log("You want to switch to: " + room_name);
            //Do not add room name yet. Added afterwards so all users can see it
            socketio.emit('switch_room', {
                user: username,
                old_room: old_room,
                room_name: room_name,
                message: 'you switched rooms!'
            });
        }

        // sends message to specific room
        function sendMessage() {
            let room_name = $('#curr_room').text();
            let msg = $("#chat_text").val();
            // console.log(msg);
            socketio.emit("message_to_server", {
                room_name: room_name,
                message: msg,
                user: username
            });
        }

        $('#send_btn').click(function() {
            socketio.emit("typing_off", username);
            if ($("#chat_text").val() != "")
                sendMessage();
            $("#chat_text").val("");
            let sh = $(".chat")[0].scrollHeight;
            // alert(sh);
            $(".chat").stop(true, false).animate({
                scrollTop: sh
            }, 500);
        })
        $("#chat_text").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#send_btn").click();
            } else if ($(this).val().length > 0) {
                console.log("typing...");
                socketio.emit("typing", username);
            } else if ($(this).val().length == 0) {
                socketio.emit("typing_off", username);
            }
        });
        // TYPING: check here instead (not on server side), user gets all typing msgs but doesn't show 
        // unless there's one already right? that sounds ez


        // LOGIN
        $("#login_btn").click(function() {
            socketio.emit("get_users");
            socketio.on("get_users", function(users) {
                console.log(users);
                let login = !users[$('#curr_room').text()].includes($("#user").val());
                login = $("#user").val() == "" ? false : login;
                console.log(login);
                if (login) {
                    console.log("Login " + $("#user").val());
                    socketio.emit("join_server", {
                        user: $("#user").val(),
                        room: $('#curr_room').text()
                    });
                    $(".login").hide();
                    $(".username").attr('id', )
                    loginUser($("#user").val());
                    $("#user").val("");
                } else {
                    console.log("Cannot login " + $("#user").val());
                }
            });
        })
        $("#user").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#login_btn").click();
            }
        });

        function loginUser(user_name) {
            username = user_name;
        }

        $("#user_menu").click(function() {
            $(".room-users").animate({
                right: "0"
            }, 300);
        });

        $("#close_users").click(function() {
            $(".room-users").animate({
                right: "-500px"
            }, 300)
        });

        $("#add_room").click(function() {
            $("#create_popup").animate({
                left: "0"
            }, 300);
        });

        $("#close_creation").click(function() {
            $("#create_popup").animate({
                left: "-500px"
            }, 300)
        });

        socketio.on("typing", function(typing_user) {
            console.log(typing_user + " is typing...");
            $("#typing").html("<em>" + typing_user + " is typing...</em>");
        });

        socketio.on("typing_off", function() {
            // console.log()
            $("#typing").html("");
        });

        socketio.on("message_to_client", function(data) {
            //Append an HR thematic break and the escaped HTML of the new message
            console.log("Received message");
            if (data.user == username)
                $(".chat .msgs").append("<p><strong class='me'>" + data.user + ":</strong> " + data.message + "</p>");
            else
                $(".chat .msgs").append("<p><strong>" + data.user + ":</strong> " + data.message + "</p>");
            // document.getElementById("chatlog_room").appendChild(document.createTextNode(data['message']));
        });

        socketio.on("create_room", function(data) {
            //Append an HR thematic break and the escaped HTML of the new message
            $("#chatlog").empty();

        });

        socketio.on("add_to_roomlist", function(data) {
            //Append an HR thematic break and the escaped HTML of the new message
            let room_name = data['room_name'];
            let pass = data.password;
            if (pass != "") {
                $('#room_list').append("<li class='room_name pass' >" + room_name + "</li>");
            } else
                $('#room_list').append("<li class='room_name' >" + room_name + "</li>");
            refresh();
        });

        socketio.on("update_users", function(data) {
            console.log(data);
            if (username == "")
                return;
            $("#user_list").empty();
            let these_users = data[$('#curr_room').text()]
            console.log(username);
            $("#user_list").append("<li class='user_name me'>" + username + "</li>");
            for (let i = 0; i < these_users.length; i++) {
                let this_user = these_users[i];
                if (this_user != username)
                    $("#user_list").append("<li class='user_name'>" + this_user + "</li>");
            }
        });

        // function createRoom() {
        //     let room_name = $('#new_room_name').val();
        //     console.log(room_name);
        //     // $('#chat_header').empty();
        //     // $('#chat_header').append("<h1 id = 'chat_title_display'>" + room_name + "</h1>");
        //     //Do not add room name yet. Added afterwards so all users can see it

        //     socketio.emit('create', {
        //         room_name: room_name,
        //         message: 'you created a new room!'
        //     });

        // }



        // $("#send_message").click(function() {
        //     sendMessage();
        // })

        $("#create_room").click(function() {
            let room_name = $('#new_room_name').val();
            if (room_name != "") {
                // console.log(room_name)
                // $('#curr_room').html(room_name);
                // $(".chat .msgs").empty();

                let old_room = $('#curr_room').text();
                // $('#curr_room').text(room_name);

                // $(".chat .msgs").empty();
                $("#close_creation").click();
                socketio.emit('create', {
                    room_name: String(room_name),
                    password: $('#room_pass').val(),
                    user: username
                });
                switchRoom(old_room, room_name);
            }
        });
        $("#new_room_name").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#create_room").click();
            }
        });

        $(document).ready(function() {
            // $('#rooms_stuff').hide();
            // $('#messaging_stuff').hide();
            // $('#chat_header').hide();
            // $('#messaging_to_room').hide();
            //Implement when we have login/register working

        });

        function refresh() {
            $(".room_name").click(function() {
                console.log("clicked on room name");
                let room_name = $(this).text();
                let old_room = $('#curr_room').text();
                switchRoom(old_room, room_name);
            });
        }
    </script>
</body>

</html>